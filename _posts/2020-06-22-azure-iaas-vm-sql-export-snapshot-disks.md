---
layout: post
title: Azure - IAAS VM + SQL export snapshot disks
date: 2020-06-22 13:00
author: beierca
comments: true
categories: [Azure, azure IAAS, export disk, Snapshot, Storage, vhd]
---
<p><!-- wp:paragraph --></p><p>Hi there</p><p><!-- /wp:paragraph -->

<!-- wp:paragraph --></p><p>In this article I'm covering a need that my client had when his IAAS SQL VM was ready for Dev, UAT environment and he didn't want to use Azure backup. He asked for the VMs disks to be exported to VHD.</p><ol><li>Shutdown the VM</li><li>Dealocated the VM</li><li>go to VM \ Settings \ Disks</li><li>on each disk do the following</li><li>select the disk you want to snapshot it</li><li>then click "+" create snapshot</li><li>go back to the VM resource group</li><li>filter items by snapshot (unselect all unneeded resources)</li></ol><p>to export the disk or even download them do the following</p><p>create a container on an available storage account on Azure (I used a different storage account for this exercise once I didn't want unauthorized access to my production storage accounts)</p><ol><li>create a new storage account</li><li>create a container under this storage account</li><li>select the storage account \ overview \ containers</li><li>"+" container to create a new container</li><li>give it a name and select "Container (anonymous read access for container and blob)" at Public access level</li><li>click create</li></ol><p>Now use the following script to copy one exported vhd (snapshot) to the container you created</p><pre>#Provide the subscription Id of the subscription where snapshot is created<br />$subscriptionId = "13a058b9-c7a4-4ba8-bca7-80743571b1ce"<br /><br />#Provide the name of your resource group where snapshot is created<br />$resourceGroupName ="Callisto"<br /><br />#Provide the snapshot name <br />$snapshotName = "sqldisk1"<br /><br /><br />#Provide Shared Access Signature (SAS) expiry duration in seconds e.g. 3600.<br />#Know more about SAS here: https://docs.microsoft.com/en-us/Az.Storage/storage-dotnet-shared-access-signature-part-1<br />$sasExpiryDuration = "36000"<br /><br />#Provide storage account name where you want to copy the snapshot. <br />$storageAccountName = "thiagobeierblog"<br /><br />#Name of the storage container where the downloaded snapshot will be stored<br />$storageContainerName = "callisto"<br /><br />#Provide the key of the storage account where you want to copy snapshot. <br />$storageAccountKey = 'ntFXNy1Hzjus7IPcKYdmTxghmzj3hnxmQFEIPYUeWLWrjFP4KShmSvYMhT/WN2YC+zsK/m2Tg3x0KOMHvtReOg=='<br /><br />#Provide the name of the VHD file to which snapshot will be copied.<br />$destinationVHDFileName = "vhd1"<br /><br /># Set the context to the subscription Id where Snapshot is created<br />Select-AzSubscription -SubscriptionId $SubscriptionId<br /><br />#Generate the SAS for the snapshot <br />$sas = Grant-AzSnapshotAccess -ResourceGroupName $ResourceGroupName -SnapshotName $SnapshotName  -DurationInSecond $sasExpiryDuration -Access Read<br />#Create the context for the storage account which will be used to copy snapshot to the storage account <br />$destinationContext = New-AzStorageContext -StorageAccountName $storageAccountName -StorageAccountKey $storageAccountKey<br /><br />#Copy the snapshot to the storage account <br />Start-AzStorageBlobCopy -AbsoluteUri $sas.AccessSAS -DestContainer $storageContainerName -DestContext $destinationContext -DestBlob $destinationVHDFileName</pre><p>You can use this one to copy as many VHDs (snapshots) you have created</p><pre>#Provide the subscription Id of the subscription where snapshot is created<br />$subscriptionId = "13a058b9-c7a4-4ba8-bca7-80743571b1ce"<br /><br />#Provide the name of your resource group where snapshot is created<br />$resourceGroupName ="Callisto"<br /><br />#Provide the snapshot name <br />$snapshotName = "sqldisk1"<br />$snapshotName1 = "sqldisk2"<br /><br />#Provide Shared Access Signature (SAS) expiry duration in seconds e.g. 3600.<br />#Know more about SAS here: https://docs.microsoft.com/en-us/Az.Storage/storage-dotnet-shared-access-signature-part-1<br />$sasExpiryDuration = "36000"<br /><br />#Provide storage account name where you want to copy the snapshot. <br />$storageAccountName = "thiagobeierblog"<br /><br />#Name of the storage container where the downloaded snapshot will be stored<br />$storageContainerName = "callisto"<br /><br />#Provide the key of the storage account where you want to copy snapshot. <br />$storageAccountKey = 'ntFXNy1Hzjus7IPcKYdmTxghmzj3hnxmQFEIPYUeWLWrjFP4KShmSvYMhT/WN2YC+zsK/m2Tg3x0KOMHvtReOg=='<br /><br />#Provide the name of the VHD file to which snapshot will be copied.<br />$destinationVHDFileName = "vhd1"<br />$destinationVHDFileName1 = "vhd2"<br /><br /><br /># Set the context to the subscription Id where Snapshot is created<br />Select-AzSubscription -SubscriptionId $SubscriptionId<br /><br />#Generate the SAS for the snapshot <br />$sas = Grant-AzSnapshotAccess -ResourceGroupName $ResourceGroupName -SnapshotName $SnapshotName  -DurationInSecond $sasExpiryDuration -Access Read<br />$sas = Grant-AzSnapshotAccess -ResourceGroupName $ResourceGroupName -SnapshotName $SnapshotName1  -DurationInSecond $sasExpiryDuration -Access Read<br />#Create the context for the storage account which will be used to copy snapshot to the storage account <br />$destinationContext = New-AzStorageContext -StorageAccountName $storageAccountName -StorageAccountKey $storageAccountKey<br /><br />#Copy the snapshot to the storage account <br />Start-AzStorageBlobCopy -AbsoluteUri $sas.AccessSAS -DestContainer $storageContainerName -DestContext $destinationContext -DestBlob $destinationVHDFileName<br />Start-AzStorageBlobCopy -AbsoluteUri $sas.AccessSAS -DestContainer $storageContainerName -DestContext $destinationContext -DestBlob $destinationVHDFileName1</pre><p>You can now download the vhd files reaching the Blob storage URL</p><p><strong><span style="color:#ff0000;">Check my <a style="color:#ff0000;" href="https://github.com/thiagobeier/scripts/blob/master/README.md"><span style="color:#0000ff;">Github</span></a> repository</span></strong></p><p><strong>References</strong><br /><br />https://docs.microsoft.com/en-us/azure/virtual-machines/scripts/virtual-machines-windows-powershell-sample-copy-snapshot-to-storage-account<br /><br /></p><p>Thanks,</p><p><!-- /wp:paragraph -->

<!-- wp:paragraph --></p><p>Thiago Beier<br /><a href="https://twitter.com/thiagobeier"><img title="Twitter" src="https://socialmediawidgets.files.wordpress.com/2014/03/twitter1.png" alt="Twitter" width="35" height="35" /></a><a href="https://www.linkedin.com/in/tbeier/"><img title="LinkedIn" src="https://socialmediawidgets.files.wordpress.com/2014/03/linkedin1.png" alt="LinkedIn" width="35" height="35" /></a><a href="https://www.facebook.com/TheBeier/"><img title="Facebook" src="https://socialmediawidgets.files.wordpress.com/2014/03/facebook1.png" alt="Facebook" width="35" height="35" /></a><a href="https://thiagobeier.wordpress.com/feed/"><img title="RSS" src="https://socialmediawidgets.files.wordpress.com/2014/03/rss1.png" alt="RSS" width="35" height="35" /></a></p><p><!-- /wp:paragraph --></p><p>&nbsp;</p>
