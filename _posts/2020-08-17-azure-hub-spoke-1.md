---
layout: post
title: Azure: Hub-Spoke #1
date: 2020-08-17 12:30
author: beierca
comments: true
categories: [Azure, hub-spoke, Networking, Peering, site-to-site vpn, vnet-to-vnet]
---
<p><!-- wp:paragraph --></p><p>Hi there</p><p style="text-align:justify;">In this article I'll demonstrate the following hub-spoke topology</p><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/hubspoke/0.png" /></p><p style="text-align:justify;">Where the goal it's to connect VM001 from Azure Subscription (A) to a physical printer located On-premises (C) passing through the VNET-to-VNET peering to (B) having this way a hub and spoke connection on Azure</p><p style="text-align:justify;"><span style="color:#ff0000;">TIPS!</span></p><ol><li style="text-align:justify;">run an assessment on all Resource Groups on each Azure subscription and export them all as a backup</li><li style="text-align:justify;">make notes of all VNETs (virtual networks) and its address space an subnets to make sure you don't have an virual network or subnets that will overlap source or target VNETs on different Azure subscriptions / Resource Groups during the VNET-to-VNET setup "peering"</li><li style="text-align:justify;">have one account on each Azure subscription with RBAC role as "network contributor" , send the proper invitation to these accounts, accept the invitation and log on https://portal.azure.com to make sure you can access target VNET properly</li><li style="text-align:justify;">have access to On-premises firewall as admin to add Azure subscription (A) VNET address space (IP address) to the site-to-site vpn networks (in our scenario we have a Sonicwall NSA)</li><li>deploy a temporary vm (vm001) to Azure subscription (A) so you can perform the tests from (A) to (B) VNET-to-VNET as well to (C) on-premises network. (I'm using an Ubuntu 18.04.5 LTS from Azure marketplace)</li><li>Configure the peering connection in the hub (subscription B) to <strong>allow gateway transit</strong>.</li><li>Configure the peering connection in each spoke (subscrition A) to <strong>use remote gateways</strong>.</li><li>Configure all peering connections (subscription A and B) to <strong>allow forwarded traffic</strong>.</li></ol><p>If you have all previous items ready to go you can go the Setup phase</p><p><strong>on Azure subscription (A)</strong></p><ul><li>Log on Azure portal</li><li>Go to the Azure Resource Group</li><li>Go to the VNET (virtual network) \ Properties</li><li>copy the Resource ID from this VNET (we'll need that to setup the VNET-to-VNET peering from B to A)</li></ul><p><strong>on Azure subscription (B)</strong></p><ul><li>Go to the VNET (virtual network) \ properties</li><li>copy the Resource ID from this VNET (we'll need that to setup the VNET-to-VNET peering from A to B)</li><li>Go to the VNET (virtual network) \ peerings </li><li>click + add<ul><li>at Name of the peering from SuperHub-vnet to remote virtual network:</li><li>at Virtual network deployment model check "I know my resource ID" and paste the VNET resource id from Azure subscripton (A)</li><li>at Directory: select the target azure subscription and click authenticate (you should be prompted to authenticate with the user who has access to target resource vnet on subscription (A)</li><li>select "enabled" for Allow virtual network access from SuperHub-vnet to remote virtual network<span style="color:var(--color-text);font-size:1rem;"><span style="color:var(--color-text);font-size:1rem;"> and</span></span><div id="_tsx_e_6025" class="azc-form-labelcontainer azc-text-label azc-text-sublabel-neighbor" aria-hidden="false">Allow forwarded traffic from remote virtual network to SuperHub-vnet<div id="azc-form-guid-056f3d1d-0f76-4655-8ac0-4919682e4d0f-balloon" class="fxc-base azc-control azc-dockedballoon azc-dockedballoon-info"> </div></div><div class="azc-formElementSubLabelContainer"> </div></li><li>check "allow gatweay transit" on this peering (the one connected to the on-premises through an Azure Gateway / site-to-site vpn).</li><li>click OK to create the peering</li></ul></li></ul><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/hubspoke/9.png" /></p><p><strong>on Azure subscription (A)</strong></p><ul><li>Go to the VNET (virtual network) \ properties</li><li>copy the Resource ID from this VNET (we'll need that to setup the VNET-to-VNET peering from B to A)</li><li>Go to the VNET (virtual network) \ peerings </li><li>click + add<ul><li>at Name of the peering from SuperHub-vnet to remote virtual network:</li><li>at Virtual network deployment model check "I know my resource ID" and paste the VNET resource id from Azure subscripton (B)</li><li>at Directory: select the target azure subscription and click authenticate (you should be prompted to authenticate with the user who has access to target resource vnet on subscription (B)</li><li>select "enabled" for Allow virtual network access from SuperHub-vnet to remote virtual network<span style="color:var(--color-text);font-size:1rem;"> and</span><div id="_tsx_e_6025" class="azc-form-labelcontainer azc-text-label azc-text-sublabel-neighbor" aria-hidden="false">Allow forwarded traffic from remote virtual network to SuperHub-vnet</div></li><li><div id="_tsx_e_6025" class="azc-form-labelcontainer azc-text-label azc-text-sublabel-neighbor" aria-hidden="false"><span style="color:var(--color-text);font-size:1rem;">check "use remote gateways" on this peering (the one connected to B).</span></div></li><li>click OK to create the peering</li></ul></li></ul><p>check on both subscriptions the peering status as <strong>Connected</strong></p><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/hubspoke/10.png" /></p><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/hubspoke/11.png" /></p><p>&nbsp;</p><p><strong>Go to Subscription (A)</strong></p><ul><li>log on the VM: vm001 (ubuntu linux)</li><li>run the apt-get update</li><li>run the apt-get upgrade</li><li>run apt-get install apache2</li><li>run "systemctl status apache2" to start the apache web service on this vm</li><li>ping a vm IP address on Azure Resource group (subscription B)</li><li>ping 10.0.4.4</li><li>ping the printer IP address located on-premises</li><li>ping 10.10.1.75</li></ul><p>&nbsp;</p><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/hubspoke/12.png" /></p><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/hubspoke/13.png" /></p><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/hubspoke/18.png" /></p><p><strong>Troubleshooting</strong></p><ol><li>check on-premises firewall<ol><li>vpn settings and allowed networks through site-to-site vpn (on-premises to subscription B resource group)</li><li>from an on-premises vm</li><li>execute a ping 10.0.4.4 vm on subscription B</li><li>execute a ping 10.100.1.7 vm on subscription A (our vm001 , apache)</li><li>try http://10.100.1.7 and check the result<br /><br /><a href="https://thiagobeierblog.blob.core.windows.net/posts/azure/hubspoke/17.png" target="_blank" rel="noopener"><img class="" style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/hubspoke/17.png" width="680" height="17" /></a><br /><br /></li></ol></li><li>check Azure vm001 (azure subscription A)<ol><li>open its virtual machine</li><li>go to networking</li><li>click on network interface</li><li>click on effective routes and wait to load</li><li>check if you can see on-premises IP address block 10.10.1.0/24</li><li>check if you can see the other VNET-to-VNET network 10.0.4.0/24 (next hop type: VNet peering)<br /><br /><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/hubspoke/6.png" /><br /><br /></li></ol></li><li>check any VM available on azure subscription B<ol><li>open its virtual machine</li><li>go to networking</li><li>click on network interface</li><li>click on effective routes and wait to load</li><li>check if you can see on-premises IP address block 10.10.1.0/24 (next hop type: Virtual network gateway)</li><li>check if you can see the other VNET-to-VNET network 10.100.0.0/16 (next hop type: VNet peering)<br /><br /><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/hubspoke/7.png" /><br /><br /></li></ol></li></ol><p>I hope that helps.</p><p>References<br />https://docs.microsoft.com/en-us/azure/architecture/reference-architectures/hybrid-networking/hub-spoke</p><p><strong><span style="color:#ff0000;">Check my <a style="color:#ff0000;" href="https://github.com/thiagobeier/scripts/blob/master/README.md"><span style="color:#0000ff;">Github</span></a> repository</span></strong></p><p><!-- /wp:paragraph -->

<!-- wp:paragraph --></p><p>Thanks,</p><p><!-- /wp:paragraph -->

<!-- wp:paragraph --></p><p>Thiago Beier<br /><a href="https://twitter.com/thiagobeier"><img title="Twitter" src="https://socialmediawidgets.files.wordpress.com/2014/03/twitter1.png" alt="Twitter" width="35" height="35" /></a><a href="https://www.linkedin.com/in/tbeier/"><img title="LinkedIn" src="https://socialmediawidgets.files.wordpress.com/2014/03/linkedin1.png" alt="LinkedIn" width="35" height="35" /></a><a href="https://www.facebook.com/TheBeier/"><img title="Facebook" src="https://socialmediawidgets.files.wordpress.com/2014/03/facebook1.png" alt="Facebook" width="35" height="35" /></a><a href="https://thiagobeier.wordpress.com/feed/"><img title="RSS" src="https://socialmediawidgets.files.wordpress.com/2014/03/rss1.png" alt="RSS" width="35" height="35" /></a></p><p><!-- /wp:paragraph --></p>
