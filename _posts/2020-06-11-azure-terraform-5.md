---
layout: post
title: Azure - Terraform #5
date: 2020-06-11 13:00
author: beierca
comments: true
categories: [Automation, Azure, main.tf, Terraform, vars.tf]
---
<p><!-- wp:paragraph --></p><p>Hi there</p><p>in this post I'm covering Azure &amp; Terraform series today I'm introducing vars.tf file which we use to declare all variables for our main.tf file to standardize our Azure through Terraform scripts.</p><p>Before we continue check your Terraform version running <strong><em>terraform --versionÂ </em></strong></p><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/terraform/5/1.png" /></p><p>Quick review</p><ol><li>download Terraform from <a href="https://www.terraform.io/downloads.html" target="_blank" rel="noopener">https://www.terraform.io/downloads.html</a></li><li>edit your Windows PATH variable to point to your terraform main folder (I have a main folder for Azure deployments with a folder on C:\TERRAFORM\ where I extract my Terraform downloaded file into)</li><li>quick commands<ol><li>az login</li><li>terraform init</li><li>terraform plan -out myplanName</li><li>terraform apply myplanName</li><li>follow up your console output to check for any warnings, errors and its deployment</li><li>terraform destroy</li></ol></li></ol><p>&nbsp;</p><p><strong>Now you're ready to continue</strong></p><p>download <strong><a href="https://thiagobeierblog.blob.core.windows.net/posts/azure/terraform/5/main.tf.txt" target="_blank" rel="noopener">main.tf</a></strong> and <strong><a href="https://thiagobeierblog.blob.core.windows.net/posts/azure/terraform/5/vars.tf.txt" target="_blank" rel="noopener">vars.tf</a></strong> for this exercise</p><p>This main.tf will create the following using variables from vars.tf</p><ol><li>azure resource group named MyTerraform5</li><li>region (location): eastus</li><li>azure VNET named mytf5-vnet</li><li>azure subnet #1 named mytf5-sbn1</li><li>azure ubuntu vm 1804 LTS named mytf5-vm01</li><li>azure public ip for the ubuntu vm named mytf5-pip01</li><li>azure nsg with firewall rule allowing ssh tcp port 22 to the vm through its public ip</li><li>vm admin user named: adminuser</li><li>vm password: P@ssw0rd@2020@</li></ol><p><strong>Let's roll</strong></p><p>go to your work directory</p><ul><li>run terraform init</li><li>run terraform plan -out mytf5-plan1</li><li>run terraform apply mytfr-plan1</li></ul><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/terraform/5/3.png" /></p><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/terraform/5/7.png" /></p><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/terraform/5/9.png" /></p><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/terraform/5/12.png" /></p><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/terraform/5/13.png" /></p><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/terraform/5/14.png" /></p><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/terraform/5/16.png" /></p><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/terraform/5/18.png" /></p><p>&nbsp;</p><p>you should now enter the variables asked on screen</p><ul><li style="text-align:justify;"><strong>var.admin_password</strong><br />Password must meet Azure complexity requirements<br />Enter a value: P@ssw0rd@2020@</li><li style="text-align:justify;"><strong>var.admin_username</strong><br />Administrator user name for virtual machine<br />Enter a value: adminuser</li><li style="text-align:justify;"><strong>var.location</strong><br />Enter a value: eastus</li></ul><p>save the info above: username and password to connect when the VM is deployed</p><p>have ready putty or any other ssh client that you like to use (Windows 10 build 18xx has built-in ssh client on it)</p><p>ssh adminuser@public_ip_address with password and you should be good (accept the RSA ssl cert, after you're logged run sudo su - to get root access)</p><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/terraform/5/20.png" /></p><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/terraform/5/21.png" /></p><p>type halt to shutdown the vm then deallocate it from the Azure portal</p><p><span style="color:#ff0000;"><strong>Files explained</strong></span></p><p>vars.tf</p><pre><strong>#enter the subscriptin id that returns from your az login command</strong><br />variable "subscription_id" {<br />type = string<br />description = "Subscription ID"<br />default = "xxxxx-zzzzz-yyyyy-aaaaa-eeeee"<br />}<br /><br /><strong>#will ask you to pick one of the declared </strong><br />variable "location" {}<br /><br /><strong>#will ask for the username you want to use/set</strong><br />variable "admin_username" {<br />type = string<br />description = "Administrator user name for virtual machine"<br />}<br /><br /><strong>#will ask for the password you want to use/set</strong><br />variable "admin_password" {<br />type = string<br />description = "Password must meet Azure complexity requirements"<br />}<br /><br /><strong>#will add the name on "default" below as prefix for all azure resources to be created on this exercise</strong><br />variable "prefix" {<br />type = string<br />default = "my"<br />}<br /><br /><strong>#will add the tags accordingly </strong><br />variable "tags" {<br />type = "map"<br /><br />default = {<br />Environment = "Terraform GS"<br />Dept = "Engineering"<br />}<br />}<br /><br /><strong>#will ask for the sku location to pick the proper vm sku (version)<br />#this location will be the default location for all resources created on this deployment</strong><br /><strong>#this example is based on the available OS image enabled / available on each location/region</strong><br />variable "sku" {<br />default = {<br />westus = "16.04-LTS"<br />eastus = "18.04-LTS"<br />}<br />}</pre><p>&nbsp;</p><p>main.tf</p><pre><strong># Configure the Microsoft Azure Provider.</strong><br />provider "azurerm" {<br />version = "~&gt;2.0"<br />features {}<br />subscription_id = var.subscription_id<br />}<br /><br /><strong># Create a resource group</strong><br />resource "azurerm_resource_group" "rg" {<br />name = "${var.prefix}TFRG"<br />location = var.location<br />tags = var.tags<br />}<br /><br /><strong># Create virtual network</strong><br />resource "azurerm_virtual_network" "vnet" {<br />name = "${var.prefix}TFVnet"<br />address_space = ["10.0.0.0/16"]<br />location = var.location<br />resource_group_name = azurerm_resource_group.rg.name<br />tags = var.tags<br />}<br /><br /><strong># Create subnet</strong><br />resource "azurerm_subnet" "subnet" {<br />name = "${var.prefix}TFSubnet"<br />resource_group_name = azurerm_resource_group.rg.name<br />virtual_network_name = azurerm_virtual_network.vnet.name<br /><strong>address_prefixes</strong> = ["10.0.1.0/24"]<br />}<br /><br /><strong># Create public IP</strong><br />resource "azurerm_public_ip" "publicip" {<br />name = "${var.prefix}TFPublicIP"<br />location = var.location<br />resource_group_name = azurerm_resource_group.rg.name<br />allocation_method = "Dynamic"<br />tags = var.tags<br />}<br /><br /><strong># Create Network Security Group and rule</strong><br />resource "azurerm_network_security_group" "nsg" {<br />name = "${var.prefix}TFNSG"<br />location = var.location<br />resource_group_name = azurerm_resource_group.rg.name<br />tags = var.tags<br /><br />security_rule {<br />name = "SSH"<br />priority = 1001<br />direction = "Inbound"<br />access = "Allow"<br />protocol = "Tcp"<br />source_port_range = "*"<br />destination_port_range = "22"<br />source_address_prefix = "*"<br />destination_address_prefix = "*"<br />}<br />}<br /><br /><strong># Create network interface</strong><br />resource "azurerm_network_interface" "nic" {<br />name = "${var.prefix}NIC"<br />location = var.location<br />resource_group_name = azurerm_resource_group.rg.name<br /># network_security_group_id = azurerm_network_security_group.nsg.id<br />tags = var.tags<br /><br />ip_configuration {<br />name = "${var.prefix}NICConfg"<br />subnet_id = azurerm_subnet.subnet.id<br />private_ip_address_allocation = "dynamic"<br />public_ip_address_id = azurerm_public_ip.publicip.id<br />}<br />}<br /><br /><strong># Create a Linux virtual machine</strong><br />resource "azurerm_virtual_machine" "vm" {<br />name = "${var.prefix}TFVM"<br />location = var.location<br />resource_group_name = azurerm_resource_group.rg.name<br />network_interface_ids = [azurerm_network_interface.nic.id]<br />vm_size = "Standard_DS1_v2"<br />tags = var.tags<br /><br />storage_os_disk {<br />name = "${var.prefix}OsDisk"<br />caching = "ReadWrite"<br />create_option = "FromImage"<br />managed_disk_type = "Premium_LRS"<br />}<br /><br />storage_image_reference {<br />publisher = "Canonical"<br />offer = "UbuntuServer"<br />sku = lookup(var.sku, var.location)<br />version = "latest"<br />}<br /><br />os_profile {<br />computer_name = "${var.prefix}TFVM"<br />admin_username = var.admin_username<br />admin_password = var.admin_password<br />}<br /><br />os_profile_linux_config {<br />disable_password_authentication = false<br />}<br /><br />}<br /><br /><strong>#defines the variable for an output on screen</strong><br />data "azurerm_public_ip" "ip" {<br />name = azurerm_public_ip.publicip.name<br />resource_group_name = azurerm_virtual_machine.vm.resource_group_name<br />}<br /><br /><strong>#displays on screen the public ip address set for the VM deployed</strong><br />output "public_ip_address" {<br />value = data.azurerm_public_ip.ip.ip_address<br />}<br /><br /><strong>#displays on screen the sku and location chosen for this deployment</strong><br />output "os_sku" {<br />value = lookup(var.sku, var.location)<br />}</pre><p>References</p><p>https://learn.hashicorp.com/terraform/azure/variables_az<br /><br /></p><p><!-- /wp:paragraph -->

<!-- wp:paragraph --></p><p>Thanks,</p><p><!-- /wp:paragraph -->

<!-- wp:paragraph --></p><p>Thiago Beier<br /><a href="https://twitter.com/thiagobeier"><img title="Twitter" src="https://socialmediawidgets.files.wordpress.com/2014/03/twitter1.png" alt="Twitter" width="35" height="35" /></a><a href="https://www.linkedin.com/in/tbeier/"><img title="LinkedIn" src="https://socialmediawidgets.files.wordpress.com/2014/03/linkedin1.png" alt="LinkedIn" width="35" height="35" /></a><a href="https://www.facebook.com/TheBeier/"><img title="Facebook" src="https://socialmediawidgets.files.wordpress.com/2014/03/facebook1.png" alt="Facebook" width="35" height="35" /></a><a href="https://thiagobeier.wordpress.com/feed/"><img title="RSS" src="https://socialmediawidgets.files.wordpress.com/2014/03/rss1.png" alt="RSS" width="35" height="35" /></a></p><p><!-- /wp:paragraph --></p>
