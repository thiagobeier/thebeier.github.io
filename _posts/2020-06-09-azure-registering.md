---
layout: post
title: Azure - Registering Programmatic Deployment
date: 2020-06-09 12:00
author: beierca
comments: true
categories: [Automation, Azure, CIS images, Marketplace, Powershell, Tips]
---
<p><!-- wp:paragraph --></p><p style="text-align:justify;">Hi there</p><p style="text-align:justify;">Today I'm demonstrating how to register programmatic deployment for CIS benchmark based VM's images from Azure marketplace to your Azure Subscription.</p><p style="text-align:justify;">Some VM's image vendors are not available for CI/CD deployment (automatically) without accepting its vendor terms before you can use it and your deployment will fail. Then you can ask, how do we solve this.</p><p style="text-align:justify;">Error you might face trying to automatically deploy Marketplace available images without accepting vendors' terms.</p><p style="text-align:justify;">Adding your preferred VM's vendor images to your azure subscription programmatic deployment.</p><p style="text-align:justify;">Go to your Azure portal </p><p>Under your Azure subscription blade check settings \ programmatic deployment blade</p><p>You should see nothing there.</p><p>Adding not available VM's vendor images to your programmatic deployment</p><p>One way to find an image in a location is to run the <a href="https://docs.microsoft.com/en-us/powershell/module/az.compute/get-azvmimagepublisher">Get-AzVMImagePublisher</a>, <a href="https://docs.microsoft.com/en-us/powershell/module/az.compute/get-azvmimageoffer">Get-AzVMImageOffer</a>, and <a href="https://docs.microsoft.com/en-us/powershell/module/az.compute/get-azvmimagesku">Get-AzVMImageSku</a> cmdlets in order:</p><ol><li>List the image publishers.</li><li>For a given publisher, list their offers.</li><li>For a given offer, list their SKUs.</li></ol><p>Open your Azure Cloud Shell</p><p>List the publishers:</p><pre><br />$locName="&lt;Azure location, such as West US&gt;"<br />Get-AzVMImagePublisher -Location $locName | Select PublisherName</pre><p>Fill in your chosen publisher name and list the offers:</p><pre>$pubName="&lt;publisher&gt;"<br />Get-AzVMImageOffer -Location $locName -PublisherName $pubName | Select Offer<br /><br />Fill in your chosen offer name and list the SKUs:<br />$offerName="&lt;offer&gt;"<br />Get-AzVMImageSku -Location $locName -PublisherName $pubName -Offer $offerName | Select Skus<br /><br />Fill in your chosen SKU name and get the image version:<br />$skuName="&lt;SKU&gt;"<br />Get-AzVMImage -Location $locName -PublisherName $pubName -Offer $offerName -Sku $skuName | Select Version<br /><br />$agreementTerms=Get-AzMarketplaceterms -Publisher "microsoft-ads" -Product "windows-data-science-vm" -Name "windows2016"<br /><br />Set-AzMarketplaceTerms -Publisher "microsoft-ads" -Product "windows-data-science-vm" -Name "windows2016" -Terms $agreementTerms -Accept</pre><p>Now you're able to see the CIS image XXX available at programmatic deployment blade under your subscription. You should be good to run the deployment without issues.</p><p>You can continue and add available marketplace VM's vendor images to your programmatic deployment by doing the following</p><p>Go to Azure portal </p><p>Go to Azure Marketplace</p><p>Search for cis ubuntu (select ubuntu 1804 available option)</p><p>At the CIS Ubuntu Linux 18.04 LTS Benchmark L1 check the "Get started" at Want to deploy programmatically? and click on it.</p><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/cis1/1.png" /><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/cis1/2.png" /></p><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/cis1/3.png" /></p><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/cis1/4.png" /></p><p>Wait a few seconds to Azure load the next blade (wizard)</p><p>Scroll down until you find your Subscription Name, Subscription ID and Status</p><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/cis1/5.png" /></p><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/cis1/6.png" /></p><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/cis1/7.png" /></p><p>&nbsp;</p><p>By default Status is set to default, toggle it to Enable and click Save (blue button)</p><p>Wait for the wizard to complete (Configuration updates completed is shown) and check the new VM under programmatic deployment at your Subscription blade.</p><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/cis1/8.png" /></p><p><img style="max-width:100%;" src="https://thiagobeierblog.blob.core.windows.net/posts/azure/cis1/9.png" /></p><p>All this effort it's to standardize your environment planning, deployment, troubleshooting and continuous monitoring on this cycle to keep your Azure environment safe and sound.</p><p><!-- /wp:paragraph -->

<!-- wp:paragraph --></p><p><em><strong>References</strong></em><br />https://docs.microsoft.com/en-us/azure/virtual-machines/windows/cli-ps-findimage<br /><br />Thanks,</p><p><!-- /wp:paragraph -->

<!-- wp:paragraph --></p><p>Thiago Beier<br /><a href="https://twitter.com/thiagobeier"><img title="Twitter" src="https://socialmediawidgets.files.wordpress.com/2014/03/twitter1.png" alt="Twitter" width="35" height="35" /></a><a href="https://www.linkedin.com/in/tbeier/"><img title="LinkedIn" src="https://socialmediawidgets.files.wordpress.com/2014/03/linkedin1.png" alt="LinkedIn" width="35" height="35" /></a><a href="https://www.facebook.com/TheBeier/"><img title="Facebook" src="https://socialmediawidgets.files.wordpress.com/2014/03/facebook1.png" alt="Facebook" width="35" height="35" /></a><a href="https://thiagobeier.wordpress.com/feed/"><img title="RSS" src="https://socialmediawidgets.files.wordpress.com/2014/03/rss1.png" alt="RSS" width="35" height="35" /></a></p><p><!-- /wp:paragraph --></p>
